# Grafana & Loki Ansible Roles Guide

This guide explains how the `grafana.grafana` collection roles work and how to manage the Loki and Alloy setup.

## 1. Installation Mechanism

You **do not need to manually install** the Loki or Alloy binaries. The Ansible roles handle the entire lifecycle:

1.  **Repository/Download**: The role automatically fetches the correct binary (Loki or Alloy) from Grafana's release page based on your architecture (amd64/arm64).
2.  **User Creation**: It creates a dedicated system user (e.g., `loki`, `alloy`) to run the service securely.
3.  **Service Setup**: It generates and installs a `systemd` unit file, so the application runs as a background service and starts on boot.
4.  **Configuration**: It transforms the YAML variables (e.g., `loki_config`, `alloy_config`) into the final configuration file on the server (e.g., `/etc/loki/config.yml`).

## 2. Setup Requirements

To make this work, you only need:
1.  **Collection**: The `grafana.grafana` collection must be installed on your control machine (your computer).
    ```bash
    ansible-galaxy collection install -r requirements.yml
    ```
2.  **Playbook Entry**: The playbook must include the role (we did this in `loki_setup` and `alloy_setup`).

## 3. Configuration Breakdown

### Loki (`roles/loki_setup/defaults/main.yml`)
The `loki_config` variable defines the entire configuration.
- **Server**: Listens on port `3100`.
- **Storage**: We configured it to use `filesystem` storage, meaning logs are saved to local disk (`/tmp/loki` in our testing setup, typically `/var/lib/loki` in production).
- **No Auth**: `auth_enabled: false` means it accepts logs without a tenant ID header (simplest for internal use).

### Alloy (`roles/alloy_setup/defaults/main.yml`)
The `alloy_config` variable defines the data pipeline.
- **loki.write**: Defines *where* to send logs (to local Loki at `http://localhost:3100`).
- **loki.source.journal**: Reads logs from the Linux system journal (`journald`).
- **loki.relabel**: filters logs. We added a rule to **keep only** logs where `container_name` matches `translations-helper`.
- **prometheus.scrape**: Connects to an invalid or test endpoint `localhost:4445`. You should verify this matches your actual service port.

## 4. Debugging & Maintenance

If things aren't working, check these locations:

**Loki**
- **Status**: `systemctl status loki`
- **Logs**: `journalctl -u loki`
- **Config File**: `/etc/loki/config.yml` (Generated by Ansible)

**Alloy**
- **Status**: `systemctl status alloy`
- **Logs**: `journalctl -u alloy`
- **UI**: Alloy provides a web UI at port `12345` (e.g., `http://localhost:12345`) where you can see the health of every component and scrape target.

## 5. Typical Workflow

1.  **Modify Defaults**: If you want to change retention or ports, edit `roles/loki_setup/defaults/main.yml`.
2.  **Apply Changes**: Run the playbook:
    ```bash
    ansible-playbook playbooks/pi.yml --tags monitoring
    ```
3.  **Restart**: Ansible automatically restarts the service if the config changes.
