# Playbook for configuring a VPS as a reverse proxy
# 
# Usage:
#   ansible-playbook -i inventory/inventory.ini playbooks/vps-proxy.yml --limit vps

- name: Configure VPS as Reverse Proxy
  hosts: vps
  gather_facts: yes
  become: yes

  vars_prompt:
    - name: tailscale_authkey
      prompt: "Enter Tailscale Auth Key (leave blank to use TAILSCALE_AUTHKEY env var or skip)"
      default: "{{ lookup('env', 'TAILSCALE_AUTHKEY') | default('', true) }}"
      private: yes

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install basic packages
      apt:
        name:
          - curl
          - ufw
        state: present

    - name: Configure UFW - Allow SSH
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Configure UFW - Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Configure UFW - Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

  roles:
    - tailscale
    - caddy

  post_tasks:
    - name: Get Tailscale IP
      command: tailscale ip -4
      register: tailscale_ip
      changed_when: false
      failed_when: false

    - name: Show status summary
      debug:
        msg: |
          ================================================
          VPS Configuration Complete!
          ================================================
          
          {% if tailscale_ip.rc == 0 %}
          Tailscale IP: {{ tailscale_ip.stdout }}
          {% else %}
          Tailscale: NOT AUTHENTICATED
          {% endif %}
          
          Next steps:
          1. Point your domain's DNS A record to: {{ ansible_host }}
          2. Wait for DNS propagation
          3. Test your sites:
          {% for site in caddy_sites %}
             curl -I https://{{ site.domain }}
          {% endfor %}
          ================================================
