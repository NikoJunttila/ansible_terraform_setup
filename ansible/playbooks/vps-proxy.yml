# Playbook for configuring a VPS as a reverse proxy
# 
# Usage:
#   ansible-playbook playbooks/vps-proxy.yml -i inventory/vps.ini \
#     -e "tailscale_authkey=tskey-xxx" \
#     -e "caddy_domain=example.com" \
#     -e "caddy_backend_ip=100.x.x.x"

- name: Configure VPS as Reverse Proxy
  hosts: all
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install basic packages
      apt:
        name:
          - curl
          - ufw
        state: present

    - name: Configure UFW - Allow SSH
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Configure UFW - Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Configure UFW - Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

  roles:
    - tailscale
    - caddy

  post_tasks:
    - name: Display Tailscale IP
      command: tailscale ip -4
      register: tailscale_ip
      changed_when: false

    - name: Show next steps
      debug:
        msg: |
          VPS Configuration Complete!
          
          Tailscale IP: {{ tailscale_ip.stdout }}
          Domain: {{ caddy_domain | default('Not configured') }}
          Backend: {{ caddy_backend_ip | default('Not configured') }}:{{ caddy_backend_port | default(80) }}
          
          Next steps:
          1. Point your domain's DNS A record to the VPS public IP
          2. Verify Caddy got SSL certificates: sudo systemctl status caddy
          3. Test the connection: curl https://{{ caddy_domain | default('yourdomain.com') }}
