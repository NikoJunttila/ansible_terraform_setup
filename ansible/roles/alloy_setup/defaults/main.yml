---
alloy_setup_env_vars:
  CUSTOM_ARGS: "--server.http.listen-addr=0.0.0.0:12345"
alloy_setup_config: |
  ////////////////////
  // LOKI SETUP. By me cuz AI sucks
  ////////////////////
  logging {
    level = "info"
  }

  loki.write "grafana_loki" {
    endpoint {
      url = "http://localhost:3100/loki/api/v1/push"
    }
  }

  loki.relabel "journal" {
    forward_to = []
  
    rule {
      source_labels = ["__journal__systemd_unit"]
      target_label  = "systemd_unit"
    }
    // Keep only logs from specific containers (multiple containers with OR pattern)
    // find the container_name with this; journalctl CONTAINER_NAME=calendar
    rule {
      source_labels = ["__journal_container_name"]
      regex = "(translations-helper|tpx-bot|calendar)"
      action = "keep"
    }
    // Optional: Add container name as a label for easier querying in Loki
    rule {
      source_labels = ["__journal_container_name"]
      target_label = "container"
    }
  }

  loki.source.journal "systemd" {
    forward_to = [loki.write.grafana_loki.receiver]
    relabel_rules = loki.relabel.journal.rules
    max_age = "24h"
  }

  
  ////////////////////
  // PROMETHEUS METRICS (NEW)
  ////////////////////
  
  // Collect Linux host metrics
  prometheus.exporter.unix "host" {}
  
  // Remote-write to Prometheus
  prometheus.remote_write "local" {
    endpoint {
      url = "http://localhost:9090/api/v1/write"
    }
  }
  
  // Relabel host metrics
  prometheus.relabel "host" {
    forward_to = [prometheus.remote_write.local.receiver]

    rule {
      target_label = "instance"
      replacement  = "raspberrypi-5"
    }

    rule {
      target_label = "job"
      replacement  = "node"
    }

    rule {
      target_label = "collector"
      replacement  = "alloy"
    }
  }

  // Wire exporter -> Prometheus
  prometheus.scrape "host" {
    targets    = prometheus.exporter.unix.host.targets
    forward_to = [prometheus.relabel.host.receiver]
  }

  // Relabel translations metrics
  prometheus.relabel "translations" {
    forward_to = [prometheus.remote_write.local.receiver]

    rule {
      target_label = "job"
      replacement  = "translations"
    }

    rule {
      target_label = "instance"
      replacement  = "{{ ansible_hostname }}"
    }
    
    rule {
      target_label = "collector"
      replacement  = "alloy"
    }
  }

  // Scrape translations-helper
  prometheus.scrape "translations" {
    targets    = [{"__address__" = "localhost:4445"}]
    forward_to = [prometheus.relabel.translations.receiver]
  }

  // Relabel Caddy metrics
  prometheus.relabel "caddy" {
    forward_to = [prometheus.remote_write.local.receiver]

    rule {
      target_label = "job"
      replacement  = "caddy"
    }

    rule {
      target_label = "instance"
      replacement  = "vps-hetzner"
    }
    
    rule {
      target_label = "collector"
      replacement  = "alloy"
    }
  }

  // Scrape Caddy metrics from VPS via Tailscale
  prometheus.scrape "caddy" {
    targets    = [{"__address__" = "{{ VPS_TAILSCALE_IP }}:2019", "__metrics_path__" = "/metrics"}]
    forward_to = [prometheus.relabel.caddy.receiver]
  }

  ////////////////////
  // TRACING (NEW)
  ////////////////////

  otelcol.receiver.otlp "default" {
    grpc {
      endpoint = "0.0.0.0:4317"
    }
    http {
      endpoint = "0.0.0.0:4318"
    }
    output {
      traces  = [otelcol.processor.batch.default.input]
    }
  }

  otelcol.processor.batch "default" {
    output {
      traces  = [otelcol.exporter.otlp.tempo.input]
    }
  }

  otelcol.exporter.otlp "tempo" {
    client {
      endpoint = "localhost:4017"
      tls {
        insecure = true
      }
    }
  }

